# 技术实现方式

本文档基于现有代码结构，对功能需求中的每个功能点进行实现方式说明（偏实现思路与关键模块）。

## 1. 基础配置与启动行为
- **默认接收路径**：在 `storage.rs` 的 `default_download_dir()` 内按盘符存在性选择 D:/rustle_downloads，否则 C:/rustle_downloads，并确保目录创建。
- **数据目录/历史目录**：`storage.rs` 中 `data_dir()` 与 `history_dir()` 负责创建本地持久化目录；`data_path()` 用于统一定位配置文件。
- **用户名加载**：在 `ui.rs` `run()` 中读取 `me.txt`（`data_path("me.txt")`）；为空则显示输入对话框。
- **启动加载**：`RustleApp::default()` 后，调用 `load_known_peers()`、`load_recent_history()`、`load_sync_tree()` 完成已知联系人/历史/同步树初始化。

## 1.1 软件设置窗口
- **入口**：在 UI 顶部或侧栏增加“设置”按钮，弹出 `egui::Window`。
- **历史记录保存天数**：
  - 配置保存到本地 JSON（建议 `settings.json` 存于 `data_dir()`）。
  - 在 `load_recent_history()` 过滤读取范围，使用用户设置的天数替换固定天数。
- **接收文件夹路径**：
  - 保存配置后覆盖 `default_download_dir()` 的默认返回逻辑（优先使用设置值）。
  - 新路径变化时确保 `create_dir_all()`。
- **发送文件/文件夹自动同步**：
  - 在 UI 发送文件/文件夹入口（`append_file_message` / `handle_dropped_files` / `pick_and_send`）增加开关判断：若关闭，则不写入同步队列/同步标记。
- **启动时更新检查**：
  - 影响 `spawn_check_update()` 的触发时机：若关闭则不自动执行。
- **本机显示名称**：
  - 设置窗口中修改后保存 `me.txt` 并触发 `NetCmd::ChangeName` 广播更新。
- **首选/固定发送网卡**：
  - 使用 `get_if_addrs` 与 `sysinfo` 的接口选择逻辑；设置后在 `get_best_interface_for_peer()` 中优先使用固定接口。

## 2. 节点发现与在线状态
- **UDP 广播发现**：
  - `net.rs` 中创建 discovery/chat UDP sockets（按网卡绑定、支持 broadcast），定期发送 `hello` 与 `heartbeat`。
- **上线/下线判定**：
  - 通过 `last_from_peer` 记录最近消息时间；超过阈值未收到心跳则触发 `PeerOffline`。
  - 收到 `hello/heartbeat/discover/sync/name_update/chat/ack` 则更新 `last_from_peer` 并置在线。
- **定向探测**：
  - 启动后对已知 IP 发起 `ProbePeer`，提升上线成功率。

## 3. 联系人管理
- **联系人列表**：
  - `ui.rs` 中维护 `users: Vec<User>`，通过 `PeerEvent::PeerOnline/PeerOffline/NameUpdate` 更新状态。
- **未读标记**：
  - 消息到达时标记 `has_unread`，选中聊天后清除。
- **删除联系人**：
  - UI 右键菜单触发删除；清理 `messages/offline_msgs/pending_acks/peers/历史文件`。

## 4. 文本聊天
- **发送**：
  - `send_message_internal()` 生成 `msg_id`，加入本地消息列表，发送 `NetCmd::SendChat`。
- **接收**：
  - `PeerEvent::ChatReceived` 更新消息列表，记录时间戳与未读。
- **昵称更新**：
  - `NameUpdate` 事件更新用户显示名。

## 5. 可靠消息与离线消息
- **ACK 机制**：
  - 发送后加入 `pending_acks`，接收 `ack` 后更新状态与历史。
- **离线队列**：
  - 发送失败进入 `offline_msgs`，对方上线 `flush_offline_queue()` 自动重发。

## 6. 文件与文件夹传输
- **文件/文件夹发送**：
  - `transfer.rs` `handle_outgoing_file()`：文件直接发送；目录先 tar 打包后发送。
- **文件夹接收**：
  - `handle_incoming_file()` 接收 tar 写入临时文件，完成后解包到目标目录。
- **进度与状态**：
  - 发送/接收过程定期上报 `PeerEvent::FileProgress`，UI 更新进度状态。
- **端口兼容**：
  - 目录连接失败时回退到文件端口发送（提高兼容性）。

## 7. 自动同步
- **同步树构建**：
  - `build_sync_node()` 递归构建目录树并记录 mtime/sha256。
- **变更检测**：
  - `maybe_start_sync_scan()` & `handle_sync_scan_result()` 比对树差异。
- **同步触发**：
  - 将变化项写入 `offline_sync`/发送队列，使用 `NetCmd::SendFile` 进行传输。

## 8. 历史记录
- **持久化**：
  - 使用 JSONL 写入 `history` 目录（每联系人一个文件）。
- **加载**：
  - `load_recent_history()` 按保存天数过滤加载。
- **更新**：
  - ACK/同步完成时更新对应历史项。

## 9. 多网卡与接口选择
- **接口选择**：
  - 启动时用 `sysinfo` 选择流量最大的接口作为默认。
  - 发送时根据目标 IP 子网或用户指定接口选择。

## 10. UI 与交互体验
- **联系人分区**：
  - `egui::SidePanel` 中在线/离线分组显示。
- **对话窗口**：
  - `egui::CentralPanel` 显示消息列表与输入框。
- **弹窗**：
  - `egui::Window` 用于用户名输入、IP 信息与更新提示。

## 11. 版本更新
- **检查更新**：
  - `spawn_check_update()` 使用 GitHub Releases API 进行检查，结果回传 UI。
